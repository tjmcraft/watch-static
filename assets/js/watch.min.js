const vid=document.querySelector("input[name=vid]").value||0;(async()=>{let e=document.querySelector(".client > .video").classList.contains("horizontal"),t=document.querySelector(".video-box"),a=t.querySelector("#video"),l=t.querySelector(".banner-muted");if(t.querySelector(".spinner"),!a||!vid)return;let n=document.querySelector("button#nextbtn"),r=document.querySelector("button#volbtn"),s=r.querySelector("i"),i=document.querySelector(".volume-slider input[type=range]"),d=document.querySelector(".volume-slider .slider-fill");n.style.display="none";let o=(e=!0)=>{e?a.muted=!0:((IS_MOBILE||IS_SAFARI)&&l.classList.remove("show"),a.muted=!1)},u=()=>{t.classList.add("waiting")};a.addEventListener("canplay",()=>{t.classList.remove("waiting")});let c=e=>{IS_MOBILE||IS_SAFARI?(l.classList.add("show"),o(!0)):o(!1),t.classList.add("waiting"),a.play().catch(e=>{console.error("play",e)}),a.addEventListener("playing",()=>{t.classList.remove("loading"),t.classList.remove("waiting"),document.querySelector(".vertical-controls > .play").classList.remove("show")}),a.addEventListener("waiting",()=>u()),a.addEventListener("progress",()=>1==a.readyState&&u())};if(data.url.endsWith(".m3u8")){if(a.canPlayType("application/vnd.apple.mpegurl"))a.src=data.url,console.debug("<<","canplay hls"),a.addEventListener("loadedmetadata",c,{once:!0});else if(Hls.isSupported()){var v=new Hls({debug:!1,enableWorker:!0,lowLatencyMode:!1,backBufferLength:30,maxBufferSize:10,maxBufferLength:5});v.loadSource(data.url),v.attachMedia(a),v.autoLevelEnabled=!0,v.startLevel=1,window.hls=v,v.on(Hls.Events.MANIFEST_PARSED,c)}}else data.url.endsWith(".mp4")&&(a.src=data.url,a.setAttribute("type","video/mp4"),console.debug("<<","canplay mp4"),a.addEventListener("loadedmetadata",c,{once:!0}));(()=>{let e=e=>location.href="/video/"+e;if(data.playlist?.items.length){let t=data.playlist.items.findIndex(e=>e.hash==data.hash)+1;if(data.playlist?.items.length>t){let l=data.playlist.items[t];a.addEventListener("ended",t=>e(l.hash),!1),n.style.display=null,n.addEventListener("click",()=>e(l.hash))}}})();{let m=(e=null)=>{if((IS_MOBILE||IS_SAFARI)&&a.muted)return e?.preventDefault(),e?.stopImmediatePropagation(),e?.stopPropagation(),o(!1),!1};t.addEventListener("click",m),l.addEventListener("click",m)}{var p=new Date().getTime(),y=0,L=!1;a.addEventListener("playing",e=>{p=new Date().getTime(),y=0,L=!1},{once:!0}),a.addEventListener("timeupdate",()=>{!a.paused&&(y=(new Date().getTime()-p)/1e3,(a.duration>=120?y>=60:y/a.duration>=.35)&&$(a.currentTime,y))});let $=(e=0,t=0)=>{if(!L){if(console.debug(">>","sendStats",e,t),vid){let a=new XMLHttpRequest;a.open("POST","/api/stats?type=view_count",!0),a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.send(JSON.stringify({vid:vid,ctw:t||0,ct:e||0}))}L=!0}}}let f=()=>{a.paused||a.ended?a.play():a.pause()};if(e){if(IS_MOBILE)a.muted=!1,a.volume=1;else{let g={muted:window.localStorage.getItem("tjmc.player.muted")??!1,volume:window.localStorage.getItem("tjmc.player.volume")??.4};a.muted=g.muted,a.volume=g.volume,a.addEventListener("volumechange",e=>{window.localStorage.getItem("tjmc.player.muted",a.muted),window.localStorage.setItem("tjmc.player.volume",a.volume)})}let h=document.querySelector(".player"),E=document.querySelector(".player .video-bottom"),S,_=!1,w=()=>S=setTimeout(()=>{a.paused||_||E.classList.remove("active")},3e3),q=()=>S&&clearTimeout(S),b=()=>{q(),E.classList.add("active"),w()},k=()=>{a.paused||E.classList.remove("active")};a.addEventListener("pause",()=>b()),E.classList.add("active"),h.addEventListener("mousemove",()=>{b()}),h.addEventListener("mouseleave",()=>{k()}),E.addEventListener("mouseenter",()=>{_=!0}),E.addEventListener("mouseleave",()=>{_=!1}),a.addEventListener("canplay",w);let T=()=>setFullscreen(IS_MOBILE?a:h);h.addEventListener("keydown",e=>{switch(e.code){case"Space":case"KeyK":f(),e.preventDefault();break;case"ArrowLeft":a.currentTime-=5,b(),e.preventDefault();break;case"ArrowRight":a.currentTime+=5,b(),e.preventDefault();break;case"ArrowDown":a.volume=Math.min(1,Math.max(0,a.volume-.05)),b(),e.preventDefault();break;case"ArrowUp":a.volume=Math.min(1,Math.max(0,a.volume+.05)),b(),e.preventDefault();break;case"KeyM":o(!a.muted),e.preventDefault();break;case"KeyF":T(),e.preventDefault()}},!0);{let x=document.querySelector("button#playpause");function D(e){"playpause"===e&&(a.paused||a.ended?x.querySelector("i").className="icon-play":x.querySelector("i").className="icon-pause")}x.addEventListener("click",f),t.addEventListener("click",f),a.addEventListener("play",()=>D("playpause"),!1),a.addEventListener("pause",()=>D("playpause"),!1)}{let A=document.querySelector("button#fullscreen");A.addEventListener("click",T),t.addEventListener("dblclick",T)}let I=document.querySelector(".video-progress");{let j=!1,B=!1,P=e=>{B=a.paused,a.pause(),j=!0,I.classList.add("active")},R=e=>{if(!j)return;"touchmove"===e.type&&"touches"in e&&void 0===e.pageX&&(e.pageX=e.touches[0].pageX);let t=I.getBoundingClientRect(),l=(e.pageX-t.left)/I.offsetWidth;a.currentTime=l*a.duration},W=e=>{j&&(j=!1,B||a.play(),I.classList.remove("active"))};I.addEventListener("mousedown",P),document.addEventListener("mousemove",R),document.addEventListener("mouseup",W),I.addEventListener("touchstart",P,{passive:!0}),document.addEventListener("touchmove",R),document.addEventListener("touchend",W),document.addEventListener("touchcancel",W),I.addEventListener("click",e=>{let t=I.getBoundingClientRect(),l=(e.pageX-t.left)/I.offsetWidth;a.currentTime=l*a.duration})}IS_MOBILE?(r.style.display="none",i.style.display="none"):(r.addEventListener("click",e=>{o(!a.muted)}),i.addEventListener("input",e=>(a.volume=i.value/100,e.preventDefault(),!1)),i.addEventListener("wheel",e=>{e.preventDefault(),a.volume=Math.min(1,Math.max(0,a.volume-.1*Math.sign(e.deltaY)))},{passive:!1}));let X=document.querySelector(".video-controls > .time"),K=I.querySelector(".played"),M=I.querySelector(".loaded");a.addEventListener("progress",function(){let e=this.buffered.end(this.buffered.length-1)/this.duration*100;M.style.width=e+"%"}),requestAnimationFrame(function e(){let t=a.currentTime/a.duration*100;K.style.width=t+"%";{let l=a.muted?0:100*a.volume;d.style.width=Math.floor(l)+"%",i.value=l,s.className=0===a.volume||a.muted?"icon-muted":a.volume<.35?"icon-volume-1":a.volume<.75?"icon-volume-2":"icon-volume-3"}if(a.readyState>=1){let n=formatTime(Math.round(a.currentTime))+"\xa0/\xa0"+formatTime(Math.round(a.duration));X.innerText!=n&&(X.innerText=n)}requestAnimationFrame(e)})}e||(IS_MOBILE?a.volume=1:a.volume=.75,a.loop=!0,document.querySelector(":root").classList.add("vertical-video"),a.addEventListener("play",()=>{document.querySelector(".vertical-controls > .play").classList.remove("show")}),a.addEventListener("pause",()=>{document.querySelector(".vertical-controls > .play").classList.add("show")}),t.addEventListener("click",f),setInterval(()=>{if(a.paused)return;let e=a.currentTime/a.duration*100;document.querySelector(".metadata").style="--progress:"+e+"%;"},50),a.addEventListener("canplay",()=>{document.querySelector(".vertical-controls > .play").classList.add("show")},{once:!0}))})();